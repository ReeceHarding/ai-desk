"use strict";exports.id=596,exports.ids=[596],exports.modules={6762:(e,t)=>{Object.defineProperty(t,"M",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},5256:(e,t,r)=>{r.d(t,{Fk:()=>u,t4:()=>m,cG:()=>l});var a=r(3939),o=r(818),i=r.n(o),s=r(3873);i().config({path:(0,s.resolve)(__dirname,"../.env")});let n=(0,a.createClient)("http://127.0.0.1:54321","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0"),c={info:async(e,t)=>{let r=new Date().toISOString();console.log(`[${r}] [Gmail Service] ${e}`,t||"");try{await n.from("audit_logs").insert({action:"gmail_service_info",description:e,metadata:{...t,timestamp:r,environment:"production"},created_at:r,status:"success"})}catch(e){console.error("Failed to log info:",e)}},error:async(e,t)=>{let r=new Date().toISOString();console.error(`[${r}] [Gmail Service] ERROR: ${e}`,t||"");try{await n.from("audit_logs").insert({action:"gmail_service_error",description:e,metadata:{error:t?JSON.stringify(t):void 0,stack:t?.stack,timestamp:r,environment:"production"},created_at:r,status:"error",error_stack:t?.stack})}catch(e){console.error("Failed to log error:",e)}}};async function l(e){try{let t=await fetch("https://gmail.googleapis.com/gmail/v1/users/me/messages",{method:"GET",headers:{Authorization:`Bearer ${e.access_token}`,"Content-Type":"application/json"}});if(!t.ok){if(401===t.status){await c.info("Access token expired, refreshing...");let t=await d(e.refresh_token);return l(t)}throw Error(`Failed to fetch Gmail messages: ${t.statusText}`)}return(await t.json()).messages||[]}catch(e){throw c.error("Error polling Gmail inbox",e),e}}function m(e){c.info("Parsing message",{messageId:e.id});let t={messageId:e.id,threadId:e.threadId,subject:e.subject||"",from:Array.isArray(e.from)?e.from[0]:e.from,to:Array.isArray(e.to)?e.to[0]:e.to,date:new Date(e.date),body:e.body||{text:"",html:""},snippet:e.snippet||"",labels:e.labelIds||[],attachments:e.attachments||[]};return c.info("Successfully parsed message",{messageId:e.id}),t}async function d(e){try{console.log("Refreshing Gmail tokens...");let t=await fetch("/api/gmail/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})});if(!t.ok)throw Error(`Failed to refresh token: ${t.statusText}`);let r=await t.json();console.log("Successfully refreshed Gmail tokens");let{data:a}=await n.from("organizations").update({gmail_access_token:r.access_token}).eq("gmail_refresh_token",e),{data:o}=await n.from("profiles").update({gmail_access_token:r.access_token}).eq("gmail_refresh_token",e);return{access_token:r.access_token,refresh_token:e,token_type:r.token_type,scope:r.scope,expiry_date:Date.now()+1e3*r.expires_in}}catch(e){throw console.error("Error refreshing Gmail tokens:",e),e}}async function f(e,t){try{c.info(`Creating ticket from email: ${e.messageId}`,{subject:e.subject});let{data:r}=await n.from("profiles").select("org_id, role").eq("id",t).single();if(!r?.org_id)throw Error("User organization not found");let{data:a,error:o}=await n.from("tickets").insert({subject:e.subject,description:e.body.text||e.snippet,status:"open",priority:"medium",customer_id:t,org_id:r.org_id,metadata:JSON.stringify({email_message_id:e.messageId,email_thread_id:e.threadId,email_from:e.from,email_to:e.to,email_date:e.date})}).select().single();if(o)throw c.error("Failed to create ticket",o),o;return c.info("Successfully created ticket from email",{ticketId:a.id}),a}catch(e){throw c.error("Error in createTicketFromEmail",e),e}}async function g(e){try{c.info("Fetching last 10 emails");let t=await fetch("https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=10",{headers:{Authorization:`Bearer ${e.access_token}`}});if(!t.ok)throw Error(`Failed to fetch messages: ${t.statusText}`);let r=await t.json(),a=[];for(let t of r.messages||[]){let r=await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${t.id}?format=full`,{headers:{Authorization:`Bearer ${e.access_token}`}});if(r.ok){let e=await r.json();a.push(e)}}return c.info(`Successfully fetched ${a.length} emails`),a}catch(e){throw c.error("Error fetching last 10 emails",e),e}}async function u(e,t){try{c.info("Starting initial email import",{userId:e});let r=await g(t);for(let t of r){let r=m(t);await f(r,e)}c.info("Completed initial email import",{userId:e,emailCount:r.length})}catch(e){throw c.error("Error during initial email import",e),e}}},2706:(e,t)=>{Object.defineProperty(t,"A",{enumerable:!0,get:function(){return r}});var r=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},9947:(e,t,r)=>{e.exports=r(5600)}};