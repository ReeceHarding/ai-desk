"use strict";(()=>{var e={};e.id=851,e.ids=[851],e.modules={3939:e=>{e.exports=require("@supabase/supabase-js")},818:e=>{e.exports=require("dotenv")},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},3873:e=>{e.exports=require("path")},4088:(e,a,r)=>{r.r(a),r.d(a,{config:()=>g,default:()=>d,routeModule:()=>m});var t={};r.r(t),r.d(t,{default:()=>p});var s=r(9947),o=r(2706),i=r(6762),n=r(3939),l=r(5256),u=r(4014);let c=(0,n.createClient)("http://127.0.0.1:54321",process.env.SUPABASE_SERVICE_ROLE_KEY);async function p(e,a){if("POST"!==e.method)return a.status(405).json({error:"Method not allowed"});try{if(!e.headers.authorization)return await u.v.error("Missing authorization header in Pub/Sub request"),a.status(401).json({error:"Unauthorized"});let r=e.body;if(!r.message?.data)return await u.v.error("Invalid Pub/Sub message format",{body:e.body}),a.status(400).json({error:"Invalid message format"});let t=JSON.parse(Buffer.from(r.message.data,"base64").toString());await u.v.info("Received Gmail notification",{emailHistoryId:t.historyId,messagePublishTime:r.message.publishTime});let{data:s,error:o}=await c.from("profiles").select("id, gmail_access_token, gmail_refresh_token").not("gmail_refresh_token","is",null);if(o)throw await u.v.error("Error fetching profiles with Gmail tokens",{error:o}),o;let i=s.map(async e=>{try{e.gmail_refresh_token&&e.gmail_access_token&&await (0,l.cG)({refresh_token:e.gmail_refresh_token,access_token:e.gmail_access_token,token_type:"Bearer",scope:"https://www.googleapis.com/auth/gmail.modify",expiry_date:0})}catch(a){await u.v.error(`Error processing mailbox for profile ${e.id}`,{error:a})}});await Promise.all(i),a.status(200).json({status:"ok"})}catch(e){await u.v.error("Error processing Pub/Sub notification",{error:e}),a.status(200).json({status:"error",message:String(e)})}}let d=(0,i.M)(t,"default"),g=(0,i.M)(t,"config"),m=new s.PagesAPIRouteModule({definition:{kind:o.A.PAGES_API,page:"/api/integrations/gmail/notify",pathname:"/api/integrations/gmail/notify",bundlePath:"",filename:""},userland:t})},4014:(e,a,r)=>{r.d(a,{v:()=>o});var t=r(3939);class s{constructor(e,a){this.supabase=(0,t.createClient)(e,a)}async logToSupabase(e,a,r){try{let{error:t}=await this.supabase.from("logs").insert([{level:e,message:a,metadata:r,timestamp:new Date().toISOString()}]);t&&console.error("Error logging to Supabase:",t)}catch(e){console.error("Failed to log to Supabase:",e)}}async info(e,a){await this.logToSupabase("info",e,a)}async warn(e,a){await this.logToSupabase("warn",e,a)}async error(e,a){await this.logToSupabase("error",e,a)}}let o=new s("http://127.0.0.1:54321",process.env.SUPABASE_SERVICE_ROLE_KEY)}};var a=require("../../../../webpack-api-runtime.js");a.C(e);var r=e=>a(a.s=e),t=a.X(0,[596],()=>r(4088));module.exports=t})();