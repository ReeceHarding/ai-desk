"use strict";(()=>{var e={};e.id=713,e.ids=[713],e.modules={3939:e=>{e.exports=require("@supabase/supabase-js")},6154:e=>{e.exports=require("google-auth-library")},3850:e=>{e.exports=require("googleapis")},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6762:(e,t)=>{Object.defineProperty(t,"M",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},9045:(e,t,r)=>{r.r(t),r.d(t,{config:()=>h,default:()=>f,routeModule:()=>m});var a={};r.r(a),r.d(a,{default:()=>g});var o=r(9947),i=r(2706),s=r(6762),n=r(3850),l=r(6154),u=r(3939),c=r(4014);let p=new l.OAuth2Client("360664812891-fab2isstn9mmq91th22ch4a1p152o2lr.apps.googleusercontent.com",process.env.GMAIL_CLIENT_SECRET,"http://localhost:3000/api/integrations/gmail/callback"),d=(0,u.createClient)("http://127.0.0.1:54321",process.env.SUPABASE_SERVICE_ROLE_KEY);async function g(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let{profile_id:r}=e.body;if(!r)return t.status(400).json({error:"Profile ID is required"});let{data:a,error:o}=await d.from("profiles").select("gmail_access_token, gmail_refresh_token").eq("id",r).single();if(o||!a)return await c.v.error("Error fetching profile",{error:o}),t.status(404).json({error:"Profile not found"});if(!a.gmail_refresh_token||!a.gmail_access_token)return t.status(400).json({error:"Gmail not connected for this profile"});p.setCredentials({access_token:a.gmail_access_token,refresh_token:a.gmail_refresh_token});let i=n.google.gmail({version:"v1",auth:p}),s=await i.users.watch({userId:"me",requestBody:{topicName:`projects/${process.env.GOOGLE_CLOUD_PROJECT}/topics/gmail-updates`,labelIds:[]}});if(!s.data.expiration)throw Error("Watch response missing expiration");let{error:l}=await d.from("profiles").update({gmail_watch_expiration:new Date(parseInt(s.data.expiration)).toISOString(),updated_at:new Date().toISOString()}).eq("id",r);if(l)throw await c.v.error("Error updating watch expiration",{error:l}),l;await c.v.info("Gmail watch registered successfully",{profile_id:r,historyId:s.data.historyId,expiration:s.data.expiration}),t.status(200).json({status:"success",expiration:s.data.expiration,historyId:s.data.historyId})}catch(e){await c.v.error("Error setting up Gmail watch",{error:e}),t.status(500).json({error:String(e)})}}let f=(0,s.M)(a,"default"),h=(0,s.M)(a,"config"),m=new o.PagesAPIRouteModule({definition:{kind:i.A.PAGES_API,page:"/api/integrations/gmail/watch",pathname:"/api/integrations/gmail/watch",bundlePath:"",filename:""},userland:a})},4014:(e,t,r)=>{r.d(t,{v:()=>i});var a=r(3939);class o{constructor(e,t){this.supabase=(0,a.createClient)(e,t)}async logToSupabase(e,t,r){try{let{error:a}=await this.supabase.from("logs").insert([{level:e,message:t,metadata:r,timestamp:new Date().toISOString()}]);a&&console.error("Error logging to Supabase:",a)}catch(e){console.error("Failed to log to Supabase:",e)}}async info(e,t){await this.logToSupabase("info",e,t)}async warn(e,t){await this.logToSupabase("warn",e,t)}async error(e,t){await this.logToSupabase("error",e,t)}}let i=new o("http://127.0.0.1:54321",process.env.SUPABASE_SERVICE_ROLE_KEY)},2706:(e,t)=>{Object.defineProperty(t,"A",{enumerable:!0,get:function(){return r}});var r=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},9947:(e,t,r)=>{e.exports=r(5600)}};var t=require("../../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=9045);module.exports=r})();