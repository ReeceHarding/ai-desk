"use strict";(()=>{var e={};e.id=644,e.ids=[644],e.modules={3939:e=>{e.exports=require("@supabase/supabase-js")},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6762:(e,r)=>{Object.defineProperty(r,"M",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},9816:(e,r,t)=>{t.r(r),t.d(r,{config:()=>p,default:()=>f,routeModule:()=>h});var a={};t.r(a),t.d(a,{default:()=>u});var o=t(9947),i=t(2706),n=t(6762),s=t(3939),l=t(4014);let c=(0,s.createClient)("http://127.0.0.1:54321",process.env.SUPABASE_SERVICE_ROLE_KEY);async function u(e,r){if("POST"!==e.method)return r.status(405).json({error:"Method not allowed"});if(e.headers.authorization!==`Bearer ${process.env.CRON_SECRET}`)return r.status(401).json({error:"Unauthorized"});try{let e=new Date(Date.now()+36e5).toISOString(),{data:t,error:a}=await c.from("profiles").select("id, gmail_watch_expiration").lt("gmail_watch_expiration",e).not("gmail_watch_expiration","is",null);if(a)throw await l.v.error("Error fetching profiles to refresh",{error:a}),a;await l.v.info(`Found ${t.length} profiles needing watch refresh`);let o=t.map(async e=>{try{let r=await fetch("http://localhost:3000/api/integrations/gmail/watch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({profile_id:e.id})});if(!r.ok)throw Error(`Failed to refresh watch for profile ${e.id}: ${r.statusText}`);await l.v.info(`Refreshed watch for profile ${e.id}`)}catch(r){await l.v.error(`Error refreshing watch for profile ${e.id}`,{error:r})}});await Promise.all(o),r.status(200).json({status:"success"})}catch(e){await l.v.error("Error in Gmail watch refresh cron",{error:e}),r.status(500).json({error:String(e)})}}let f=(0,n.M)(a,"default"),p=(0,n.M)(a,"config"),h=new o.PagesAPIRouteModule({definition:{kind:i.A.PAGES_API,page:"/api/cron/refresh-gmail-watches",pathname:"/api/cron/refresh-gmail-watches",bundlePath:"",filename:""},userland:a})},4014:(e,r,t)=>{t.d(r,{v:()=>i});var a=t(3939);class o{constructor(e,r){this.supabase=(0,a.createClient)(e,r)}async logToSupabase(e,r,t){try{let{error:a}=await this.supabase.from("logs").insert([{level:e,message:r,metadata:t,timestamp:new Date().toISOString()}]);a&&console.error("Error logging to Supabase:",a)}catch(e){console.error("Failed to log to Supabase:",e)}}async info(e,r){await this.logToSupabase("info",e,r)}async warn(e,r){await this.logToSupabase("warn",e,r)}async error(e,r){await this.logToSupabase("error",e,r)}}let i=new o("http://127.0.0.1:54321",process.env.SUPABASE_SERVICE_ROLE_KEY)},2706:(e,r)=>{Object.defineProperty(r,"A",{enumerable:!0,get:function(){return t}});var t=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},9947:(e,r,t)=>{e.exports=t(5600)}};var r=require("../../../webpack-api-runtime.js");r.C(e);var t=r(r.s=9816);module.exports=t})();